<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股市走向輪盤</title>
    <style>
        :root {
            --up-color: #ff4d4d;
            --down-color: #2ecc71;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary: #2c3e50;
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            color: #2c3e50;
        }

        .container { max-width: 900px; width: 100%; text-align: center; }

        /* 數據面板 */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .stat-card h3 { margin: 0; font-size: 13px; color: #7f8c8d; }
        .stat-card .value { font-size: 28px; font-weight: 800; margin-top: 8px; }
        .price-up { color: var(--up-color); }
        .price-down { color: var(--down-color); }

        /* 圖表 Modal */
        #chart-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            position: relative;
        }
        .close-chart {
            position: absolute;
            top: 15px; right: 20px;
            font-size: 24px; cursor: pointer; color: #999;
        }

        /* 輪盤區域 */
        .wheel-container {
            position: relative;
            width: 350px; height: 350px;
            margin: 10px auto;
        }
        #wheel-canvas {
            width: 100%; height: 100%;
            transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1);
        }
        .pointer {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-top: 35px solid #2c3e50; z-index: 10;
        }

        /* 按鈕區 */
        .main-btns { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 10px; }
        .action-row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        
        button { cursor: pointer; transition: 0.3s; font-weight: bold; border: none; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .spin-btn {
            background: var(--primary); color: white;
            padding: 16px 60px; font-size: 20px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
        }
        .chart-btn { background: #3498db; color: white; padding: 10px 20px; border-radius: 5px; }
        .edit-btn { background: #ecf0f1; border: 1px solid #bdc3c7; padding: 10px 15px; border-radius: 5px; }
        .reset-btn { background: #e67e22; color: white; padding: 10px 20px; border-radius: 5px; }

        .manual-control input { width: 70px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }

        /* 紀錄表 */
        .history-section {
            margin-top: 25px; background: var(--card-bg); border-radius: 12px;
            overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); width: 100%;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #f1f1f1; }
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 11px; color: white; }
    </style>
</head>
<body>

    <div class="container">
        <h1>股市走向輪盤</h1>

        <div class="dashboard">
            <div class="stat-card">
                <h3>盤中時間</h3>
                <div class="value" id="current-time">09:30</div>
            </div>
            <div class="stat-card">
                <h3>目前股價</h3>
                <div class="value" id="current-price">500</div>
                <div style="margin-top:5px">
                    <input type="number" id="manual-price-input" placeholder="價格">
                    <button style="font-size:10px" onclick="setManualPrice()">設定</button>
                </div>
            </div>
            <div class="stat-card">
                <h3>當前輪次</h3>
                <div class="value" id="current-round">第 0 / 14 輪</div>
            </div>
        </div>

        <div class="wheel-container">
            <div class="pointer"></div>
            <canvas id="wheel-canvas" width="600" height="600"></canvas>
        </div>

        <div class="main-btns">
            <button id="spin-btn" class="spin-btn">啟動輪盤</button>
            
            <div class="action-row">
                <button class="chart-btn" onclick="openChart()">檢視趨勢圖表</button>
                <button id="undo-btn" class="edit-btn" onclick="undo()">復原</button>
                <button id="redo-btn" class="edit-btn" onclick="redo()">重做</button>
                <button class="reset-btn" onclick="resetGame()">新開盤重置</button>
            </div>
        </div>
        
        <div id="status-msg" style="margin-top:10px; font-weight:bold; color:#e67e22"></div>

        <div class="history-section">
            <table>
                <thead>
                    <tr><th>時間</th><th>事件</th><th>漲跌</th><th>股價</th></tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>

    <div id="chart-modal">
        <div class="modal-content">
            <span class="close-chart" onclick="closeChart()">&times;</span>
            <h2 style="margin-top:0">今日股價走勢分析</h2>
            <canvas id="trend-canvas" width="700" height="350" style="width:100%"></canvas>
            <div style="display:flex; justify-content:center; gap:20px; margin-top:10px">
                <span style="color:var(--up-color)">● 上漲時段</span>
                <span style="color:var(--down-color)">● 下跌時段</span>
            </div>
        </div>
    </div>

    <script>
        // --- 核心狀態 ---
        let gameState = {
            currentPrice: 500,
            currentRound: 0,
            history: [], // 格式: {time, label, price, change}
            eventPool: [],
            lastRotation: 0,
            currentTimeStr: "09:30",
            pricePath: [500] // 用於繪圖的價格路徑 [初始, R1, R2...]
        };

        let undoStack = [];
        let redoStack = [];

        const config = [
            { label: '央行大降息', change: 1.5, color: '#e74c3c', count: 1 },
            { label: '科技股爆漲', change: 0.8, color: '#ff7675', count: 2 },
            { label: '外資湧入', change: 0.5, color: '#fab1a0', count: 3 },
            { label: '小跌', change: -0.2, color: '#55efc4', count: 3 },
            { label: '中跌', change: -0.4, color: '#00b894', count: 2 },
            { label: '崩盤', change: -0.9, color: '#009432', count: 1 }
        ];

        // --- 趨勢圖繪製邏輯 ---
        function openChart() {
            document.getElementById('chart-modal').style.display = 'flex';
            drawTrendChart();
        }

        function closeChart() {
            document.getElementById('chart-modal').style.display = 'none';
        }

        function drawTrendChart() {
            const canvas = document.getElementById('trend-canvas');
            const ctx = canvas.getContext('2d');
            const data = gameState.pricePath;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const padding = 40;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;

            // 計算座標範圍
            const maxPrice = Math.max(...data, 600) * 1.1;
            const minPrice = Math.min(...data, 0) * 0.9;
            const priceRange = maxPrice - minPrice;

            function getX(i) { return padding + (i * (chartWidth / 14)); }
            function getY(p) { return canvas.height - padding - ((p - minPrice) / priceRange * chartHeight); }

            // 繪製格線
            ctx.strokeStyle = '#eee';
            ctx.lineWidth = 1;
            for(let i=0; i<=5; i++) {
                let y = padding + (i * chartHeight / 5);
                ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(canvas.width - padding, y); ctx.stroke();
            }

            // 繪製線段
            for (let i = 1; i < data.length; i++) {
                ctx.beginPath();
                ctx.lineWidth = 3;
                ctx.strokeStyle = data[i] >= data[i-1] ? '#ff4d4d' : '#2ecc71';
                ctx.moveTo(getX(i-1), getY(data[i-1]));
                ctx.lineTo(getX(i), getY(data[i]));
                ctx.stroke();

                // 繪製點
                ctx.fillStyle = ctx.strokeStyle;
                ctx.beginPath();
                ctx.arc(getX(i), getY(data[i]), 4, 0, Math.PI * 2);
                ctx.fill();
            }

            // 座標標籤
            ctx.fillStyle = "#999";
            ctx.font = "12px Arial";
            ctx.fillText(Math.floor(maxPrice), 5, padding);
            ctx.fillText(Math.floor(minPrice), 5, canvas.height - padding);
            ctx.fillText("09:30", padding, canvas.height - 10);
            ctx.fillText("11:50", canvas.width - padding - 30, canvas.height - 10);
        }

        // --- 核心邏輯 (其餘保持原樣並整合 pricePath) ---
        function saveSnapshot() {
            undoStack.push(JSON.stringify(gameState));
            redoStack = [];
            updateButtons();
        }

        function updateButtons() {
            document.getElementById('undo-btn').disabled = undoStack.length === 0;
            document.getElementById('redo-btn').disabled = redoStack.length === 0;
        }

        function undo() {
            if (undoStack.length === 0) return;
            redoStack.push(JSON.stringify(gameState));
            gameState = JSON.parse(undoStack.pop());
            sync();
        }

        function redo() {
            if (redoStack.length === 0) return;
            undoStack.push(JSON.stringify(gameState));
            gameState = JSON.parse(redoStack.pop());
            sync();
        }

        function sync() {
            document.getElementById('current-price').innerText = gameState.currentPrice;
            document.getElementById('current-time').innerText = gameState.currentTimeStr;
            document.getElementById('current-round').innerText = `第 ${gameState.currentRound} / 14 輪`;
            document.getElementById('wheel-canvas').style.transform = `rotate(${gameState.lastRotation}deg)`;
            
            const body = document.getElementById('history-body');
            body.innerHTML = '';
            gameState.history.forEach(h => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${h.time}</td><td><span class="tag" style="background:${h.color}">${h.label}</span></td>
                                 <td style="color:${h.change >= 0 ? 'var(--up-color)' : 'var(--down-color)'}">${h.cp}</td>
                                 <td><strong>${h.price}</strong></td>`;
                body.appendChild(row);
            });

            document.getElementById('spin-btn').disabled = gameState.currentRound >= 14;
            localStorage.setItem('stock_game_final', JSON.stringify(gameState));
            updateButtons();
        }

        function setManualPrice() {
            const val = parseInt(document.getElementById('manual-price-input').value);
            if(!isNaN(val)) {
                saveSnapshot();
                gameState.currentPrice = val;
                gameState.pricePath[gameState.currentRound] = val;
                sync();
            }
        }

        document.getElementById('spin-btn').addEventListener('click', () => {
            if(gameState.currentRound >= 14) return;
            saveSnapshot();
            document.getElementById('spin-btn').disabled = true;

            const idx = gameState.currentRound;
            const ev = gameState.eventPool[idx];
            const rot = gameState.lastRotation + (360 * 7) + ((14 - idx) * (360/14)) - (gameState.lastRotation % 360) - (360/28) - 90;
            
            document.getElementById('wheel-canvas').style.transform = `rotate(${rot}deg)`;
            gameState.lastRotation = rot;

            setTimeout(() => {
                gameState.currentPrice = Math.floor(gameState.currentPrice * (1 + ev.change));
                let [h, m] = gameState.currentTimeStr.split(':').map(Number);
                m += 10; if(m>=60){h++; m=0;}
                gameState.currentTimeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                
                gameState.history.unshift({
                    time: gameState.currentTimeStr, label: ev.label, color: ev.color,
                    change: ev.change, cp: (ev.change >= 0 ? '+' : '') + (ev.change*100) + '%',
                    price: gameState.currentPrice
                });
                gameState.currentRound++;
                gameState.pricePath.push(gameState.currentPrice);
                sync();
            }, 4000);
        });

        function resetGame() {
            if(confirm("重置所有數據？")) { localStorage.removeItem('stock_game_final'); location.reload(); }
        }

        // 初始化繪圖與數據
        const canvasW = document.getElementById('wheel-canvas');
        const ctxW = canvasW.getContext('2d');
        function drawW() {
            const slice = (Math.PI*2)/14;
            gameState.eventPool.forEach((e, i) => {
                ctxW.beginPath(); ctxW.fillStyle = e.color; ctxW.moveTo(300, 300);
                ctxW.arc(300, 300, 290, i*slice, (i+1)*slice); ctxW.fill();
                ctxW.strokeStyle = 'white'; ctxW.stroke();
                ctxW.save(); ctxW.translate(300, 300); ctxW.rotate(i*slice + slice/2);
                ctxW.fillStyle = "white"; ctxW.font = "bold 16px Arial"; ctxW.fillText(e.label, 120, 8); ctxW.restore();
            });
        }

        // 載入或新建
        const saved = localStorage.getItem('stock_game_final');
        if(saved) {
            gameState = JSON.parse(saved);
        } else {
            let p = []; config.forEach(c => { for(let i=0; i<c.count; i++) p.push({...c}); });
            for(let i=0; i<2; i++) p.push({...config[Math.floor(Math.random()*6)]});
            for(let i=p.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [p[i],p[j]]=[p[j],p[i]]; }
            gameState.eventPool = p;
        }
        drawW();
        sync();
    </script>
</body>
</html>